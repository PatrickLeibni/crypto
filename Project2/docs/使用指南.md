# 使用指南

## 1. 快速开始

### 1.1 环境准备
```bash
# 安装Python 3.7+
python --version

# 安装依赖
pip install -r requirements.txt

# 验证安装
python tests/test_installation.py
```

### 1.2 基本使用
```python
from src.watermark import DigitalWatermark

# 初始化水印系统
watermark_system = DigitalWatermark(alpha=0.15)

# 嵌入水印
original_img, watermarked_img = watermark_system.embed_watermark(
    "input.jpg",
    message="My watermark",
    output_path="output.jpg"
)

# 检测水印
detected, similarity = watermark_system.detect_watermark(
    "output.jpg",
    original_size=(512, 512),
    watermark_size=4096,
    expected_message="My watermark"
)
```

## 2. 命令行工具

### 2.1 创建示例图片
```bash
python cli.py create-sample -o sample.jpg --width 512 --height 512
```

### 2.2 嵌入水印
```bash
python cli.py embed -i sample.jpg -o watermarked.jpg -m "My watermark" -a 0.15
```

参数说明：
- `-i, --input`: 输入图片路径
- `-o, --output`: 输出图片路径
- `-m, --message`: 水印消息
- `-a, --alpha`: 水印强度 (0.01-0.5)
- `-s, --seed`: 随机种子

### 2.3 提取水印
```bash
python cli.py extract -i watermarked.jpg -a 0.15
```

### 2.4 检测水印
```bash
python cli.py detect -i watermarked.jpg -m "My watermark" -t 0.6
```

参数说明：
- `-t, --threshold`: 检测阈值 (0.5-0.9)

### 2.5 鲁棒性测试
```bash
python cli.py test -i watermarked.jpg -m "My watermark" --report report.txt --plot plot.png
```

## 3. 高级使用

### 3.1 批量处理
```python
import os
from src.watermark import DigitalWatermark

watermark_system = DigitalWatermark(alpha=0.15)

# 批量嵌入水印
input_dir = "input_images/"
output_dir = "output_images/"

for filename in os.listdir(input_dir):
    if filename.endswith(('.jpg', '.png')):
        input_path = os.path.join(input_dir, filename)
        output_path = os.path.join(output_dir, f"watermarked_{filename}")
        
        watermark_system.embed_watermark(
            input_path,
            message="Batch watermark",
            output_path=output_path
        )
```

### 3.2 自定义鲁棒性测试
```python
from src.robustness_test import RobustnessTester

watermark_system = DigitalWatermark(alpha=0.15)
tester = RobustnessTester(watermark_system)

# 自定义测试参数
custom_angles = [10, 20, 30]
custom_noise_levels = [0.05, 0.1]

for angle in custom_angles:
    rotated_path = tester.apply_rotation("watermarked.jpg", angle)
    # 进行水印检测
    detected, similarity = watermark_system.detect_watermark(
        rotated_path,
        original_size=(512, 512),
        watermark_size=4096,
        expected_message="Test watermark"
    )
    print(f"旋转 {angle}°: {'成功' if detected else '失败'} (相似度: {similarity:.4f})")
```

### 3.3 性能优化
```python
import time
from utils import benchmark_performance

# 性能测试
watermark_system = DigitalWatermark(alpha=0.15)

result, execution_time = benchmark_performance(
    watermark_system.embed_watermark,
    "input.jpg",
    message="Performance test"
)

print(f"嵌入时间: {execution_time:.4f}秒")
```

## 4. 参数调优

### 4.1 α参数调优
```python
# 测试不同α值的影响
alphas = [0.05, 0.1, 0.15, 0.2, 0.25]

for alpha in alphas:
    watermark_system = DigitalWatermark(alpha=alpha)
    
    # 嵌入水印
    original_img, watermarked_img = watermark_system.embed_watermark(
        "input.jpg",
        message="Alpha test"
    )
    
    # 计算PSNR
    psnr = calculate_psnr(original_img, watermarked_img)
    
    # 检测水印
    detected, similarity = watermark_system.detect_watermark(
        "watermarked.jpg",
        original_size=(512, 512),
        watermark_size=4096,
        expected_message="Alpha test"
    )
    
    print(f"α={alpha}: PSNR={psnr:.2f}dB, 检测={'成功' if detected else '失败'}, 相似度={similarity:.4f}")
```

### 4.2 阈值调优
```python
# 测试不同阈值的影响
thresholds = [0.5, 0.6, 0.7, 0.8, 0.9]

for threshold in thresholds:
    detected, similarity = watermark_system.detect_watermark(
        "watermarked.jpg",
        original_size=(512, 512),
        watermark_size=4096,
        expected_message="Test watermark",
        threshold=threshold
    )
    
    print(f"阈值={threshold}: 检测={'成功' if detected else '失败'}, 相似度={similarity:.4f}")
```

## 5. 错误处理

### 5.1 常见错误及解决方案

#### 图片读取错误
```python
try:
    watermark_system.embed_watermark("nonexistent.jpg", "test")
except ValueError as e:
    print(f"图片读取错误: {e}")
    # 检查文件是否存在
    if not os.path.exists("nonexistent.jpg"):
        print("文件不存在")
```

#### 参数错误
```python
try:
    watermark_system = DigitalWatermark(alpha=2.0)  # α值超出范围
except ValueError as e:
    print(f"参数错误: {e}")
    # 使用默认值
    watermark_system = DigitalWatermark()
```

#### 内存不足
```python
try:
    # 处理大图片
    watermark_system.embed_watermark("large_image.jpg", "test")
except MemoryError:
    print("内存不足，请减小图片尺寸或增加系统内存")
```

## 6. 最佳实践

### 6.1 图片预处理
```python
import cv2
import numpy as np

def preprocess_image(image_path, target_size=(512, 512)):
    """图片预处理"""
    # 读取图片
    img = cv2.imread(image_path)
    
    # 调整尺寸
    img = cv2.resize(img, target_size)
    
    # 确保尺寸是8的倍数
    h, w = img.shape[:2]
    h = (h // 8) * 8
    w = (w // 8) * 8
    img = img[:h, :w]
    
    return img

# 使用预处理
original_img = preprocess_image("input.jpg")
cv2.imwrite("preprocessed.jpg", original_img)
```

### 6.2 水印消息设计
```python
# 使用有意义的消息
watermark_message = "Copyright 2024 - Digital Watermark System"

# 包含时间戳
import datetime
timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
watermark_message = f"Watermark_{timestamp}"

# 包含用户信息
user_id = "user123"
watermark_message = f"User:{user_id}_Time:{timestamp}"
```

### 6.3 结果验证
```python
def verify_watermark(original_path, watermarked_path, expected_message):
    """验证水印嵌入结果"""
    watermark_system = DigitalWatermark(alpha=0.15)
    
    # 获取图片信息
    original_img = cv2.imread(original_path)
    h, w = original_img.shape[:2]
    watermark_size = (h // 8) * (w // 8)
    
    # 检测水印
    detected, similarity = watermark_system.detect_watermark(
        watermarked_path,
        original_size=(h, w),
        watermark_size=watermark_size,
        expected_message=expected_message
    )
    
    # 计算PSNR
    watermarked_img = cv2.imread(watermarked_path)
    psnr = calculate_psnr(original_img, watermarked_img)
    
    print(f"水印检测: {'成功' if detected else '失败'}")
    print(f"相似度: {similarity:.4f}")
    print(f"PSNR: {psnr:.2f} dB")
    
    return detected, similarity, psnr
```

## 7. 故障排除

### 7.1 检测失败
- 检查α参数是否合适
- 验证水印消息是否正确
- 确认图片尺寸是否为8的倍数
- 检查随机种子是否一致

### 7.2 图片质量差
- 降低α参数值
- 检查图片格式和压缩质量
- 确保图片尺寸足够大

### 7.3 鲁棒性差
- 增加α参数值
- 选择更鲁棒的嵌入位置
- 使用更复杂的编码方案

## 8. 性能优化建议

### 8.1 内存优化
- 处理大图片时分块处理
- 及时释放不需要的变量
- 使用生成器处理大量图片

### 8.2 速度优化
- 使用多线程处理批量图片
- 预计算DCT变换表
- 使用GPU加速（如果可用）

### 8.3 精度优化
- 使用双精度浮点数
- 避免多次压缩和转换
- 保持原始图片质量 