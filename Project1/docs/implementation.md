# SM4算法实现详解

## 概述

SM4是中国国家密码管理局发布的分组密码算法，采用128位密钥和128位分组长度。

## 算法原理

### 基本结构
- 32轮加密
- 128位密钥和分组长度
- Feistel网络结构
- 非线性S盒替换 + 线性变换L

### 密钥扩展
```c
void sm4_key_expansion(uint8_t *key, uint32_t *rk) {
    uint32_t K[36], k[36];
    
    // 将密钥转换为32位字
    for (int i = 0; i < 4; i++) {
        K[i] = GETU32(key + 4 * i);
    }
    
    // 应用密钥扩展算法
    for (int i = 0; i < 32; i++) {
        k[i] = K[i] ^ FK[i];
    }
    
    for (int i = 0; i < 32; i++) {
        rk[i] = k[i + 4] = k[i] ^ T'(k[i + 1] ^ k[i + 2] ^ k[i + 3] ^ CK[i]);
    }
}
```

### 轮函数
每轮包含：S盒替换 → 线性变换L → 与轮密钥异或

## 实现版本

| 实现 | 特点 | 性能提升 | 兼容性 |
|------|------|---------|--------|
| 基本实现 | 标准C语言，逐字节处理 | 基准 | 高 |
| T-table优化 | 预计算T函数值 | 2-3x | 高 |
| AESNI优化 | 利用Intel AES指令集 | 3-5x | 中 |
| GFNI优化 | 使用伽罗瓦域新指令 | 5-8x | 中 |
| VPROLD优化 | 使用最新VPROLD指令 | 8-12x | 低 |
| AVX-512优化 | 512位向量批量处理 | 10-20x | 低 |

## 代码结构

```
src/
├── sm4_basic.c          # 基本实现
├── sm4_ttable.c         # T-table优化
├── sm4_aesni.c          # AESNI优化
├── sm4_gfni.c           # GFNI优化
├── sm4_vprold.c         # VPROLD优化
├── sm4_avx512_gfni.c    # AVX-512+GFNI优化
├── sm4_avx512_vprold.c  # AVX-512+VPROLD优化
├── sm4_gcm.c            # GCM模式实现
└── test_sm4.c           # 测试程序
```

## 优化策略

### 1. 向量化处理
- 使用SIMD指令集并行处理多个数据块
- 减少循环开销

### 2. 查表优化
- 预计算常用值，减少重复计算
- 平衡内存和性能

### 3. 指令集优化
- 利用专用指令减少指令数量
- 提高执行效率

## 测试验证

### 正确性测试
- 标准测试向量验证
- 边界条件测试
- 随机数据测试

### 性能测试
- 吞吐量测试（MB/s）
- 延迟测试（微秒/块）
- 不同数据大小测试

### 兼容性测试
- 不同CPU架构验证
- 不同编译器测试
- 不同操作系统验证

## 安全考虑

1. **侧信道攻击防护**: 使用恒定时间实现
2. **内存安全**: 及时清理敏感数据
3. **密钥管理**: 安全的密钥存储和传输 